<!DOCTYPE html>  
<html class="dark" lang="en">  
<head>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<meta name="theme-color" content="#000000">  
<meta charset="utf-8"/>  
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
<title>R Studio - Web Code Editor</title>  

<!-- Tailwind -->  
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>  

<!-- Fonts -->  
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>  
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>  

<!-- CodeMirror -->  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">  
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>  
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/r/r.min.js"></script>  
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/closebrackets.min.js"></script>  
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/selection/active-line.min.js"></script>  

<script id="tailwind-config">  
  tailwind.config = {  
    darkMode: "class",  
    theme: {  
      extend: {  
        colors: {  
          primary: "#24ffda",  
          "background-light": "#f5f8f8",  
          "background-dark": "#0A0A0A",  
          "panel-dark": "rgba(10, 25, 30, 0.6)",  
          accent: "#00F5D4",  
          "text-light": "#EAEAEA",  
          "text-muted": "#888888",  
        },  
        fontFamily: {  
          display: ["Space Grotesk", "sans-serif"],  
        },  
      },  
    },  
  };  
</script>  

<style>  
/* --- Custom dark aqua theme for CodeMirror --- */  
.CodeMirror {  
  height: 100%;  
  width: 100%;  
  background-color: #0A0A0A !important;  
  color: #EAEAEA !important;  
  font-size: 0.9rem;  
  font-family: 'Space Grotesk', monospace;  
  line-height: 1.5;  
}  
.cm-s-aquastudio span.cm-keyword { color: #00F5D4; font-weight: 500; }  
.cm-s-aquastudio span.cm-atom { color: #2DD4BF; }  
.cm-s-aquastudio span.cm-number { color: #F87171; }  
.cm-s-aquastudio span.cm-def { color: #38BDF8; }  
.cm-s-aquastudio span.cm-variable { color: #EAEAEA; }  
.cm-s-aquastudio span.cm-variable-2 { color: #C084FC; }  
.cm-s-aquastudio span.cm-string { color: #A7F3D0; }  
.cm-s-aquastudio span.cm-comment { color: #6B7280; font-style: italic; }  
.cm-s-aquastudio span.cm-operator { color: #93C5FD; }  
.cm-s-aquastudio span.cm-meta { color: #FBBF24; }  
.cm-s-aquastudio span.cm-builtin { color: #22D3EE; }  
.cm-s-aquastudio span.cm-tag { color: #FCA5A5; }  
.cm-s-aquastudio span.cm-attribute { color: #FCD34D; }  
.cm-s-aquastudio span.cm-error { color: #F87171; text-decoration: underline; }  
.cm-s-aquastudio .CodeMirror-cursor { border-left: 2px solid #00F5D4; }  
.cm-s-aquastudio .CodeMirror-activeline-background { background: rgba(0, 245, 212, 0.07); }  
.cm-s-aquastudio .CodeMirror-gutters { background-color: #0A0A0A; border-right: 1px solid rgba(255,255,255,0.08); }  
.cm-s-aquastudio .CodeMirror-linenumber { color: #4B5563; }  

body { min-height: 100dvh; }  
/* --- Custom Scrollbars (Dark Aqua Theme) --- */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: #0A0A0A; /* same as background-dark */
}

::-webkit-scrollbar-thumb {
  background-color: #00F5D4; /* aqua accent */
  border-radius: 8px;
  border: 2px solid #0A0A0A; /* gives space around thumb */
}

::-webkit-scrollbar-thumb:hover {
  background-color: #24ffda; /* brighter on hover */
}

/* For Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: #00F5D4 #0A0A0A;
}
</style>  
</head>  

<body class="bg-background-dark font-display text-text-light relative min-h-screen overflow-hidden">  
<!-- Background -->  
<div class="absolute inset-0 z-0 overflow-hidden">  
  <div class="absolute -top-1/4 -left-1/4 h-1/2 w-1/2 rounded-full bg-accent/20 blur-3xl blob-1"></div>  
  <div class="absolute -bottom-1/4 -right-1/4 h-1/2 w-1/2 rounded-full bg-accent/30 blur-3xl blob-2"></div>  
</div>  

<div class="relative z-10 flex flex-col h-screen w-full">  
  <!-- Header -->  
  <header class="flex h-14 sm:h-16 items-center justify-between border-b border-white/10 bg-panel-dark px-4 sm:px-6 shadow-lg backdrop-blur-md">  
    <h2 class="text-lg sm:text-xl font-bold tracking-[-0.015em]">Project: data-analysis</h2>  
    <button id="save-btn" class="hover:text-accent flex items-center gap-1 text-sm font-semibold">  
      <span class="material-symbols-outlined">save</span> Save  
    </button>  
  </header>  

  <div class="flex flex-1 overflow-hidden">  
    <!-- Sidebar (Dynamic Files) -->  
    <aside class="w-64 shrink-0 flex-col border-r border-white/10 bg-panel-dark p-4 shadow-lg backdrop-blur-md">  
      <div class="mb-4">  
        <input id="search-files" type="search" placeholder="Search files..."   
               class="w-full rounded-lg border border-white/20 bg-white/5 px-3 py-2 text-sm text-text-light placeholder-text-muted focus:border-accent focus:bg-white/10 focus:outline-none"/>  
      </div>  
      <nav id="file-list" class="flex flex-col gap-1"></nav>  
    </aside>  

    <!-- Main -->  
    <main class="flex flex-1 flex-col overflow-hidden">  
      <div id="tabs" class="border-b border-white/10 bg-panel-dark/50 backdrop-blur-sm">  
        <div class="flex gap-2 px-3 pt-2 overflow-x-auto"></div>  
      </div>  

      <div class="flex flex-1 md:flex-row flex-col overflow-hidden bg-background-dark/80">  
        <!-- Code Editor -->  
        <div class="flex-1 flex overflow-hidden p-3 sm:p-4 code-area">  
          <textarea id="code-editor"></textarea>  
        </div>  

        <!-- Preview Screen -->  
        <div class="console h-60 md:h-auto md:w-1/3 flex flex-col border-t md:border-t-0 md:border-l border-white/10 bg-panel-dark shadow-lg backdrop-blur-md">  
          <div class="flex items-center justify-between border-b border-white/10 px-3 sm:px-4 py-2">  
            <h3 class="text-sm sm:text-base font-bold">Preview</h3>  
            <button id="clear-preview" class="text-xs sm:text-sm text-text-muted hover:text-accent">Clear</button>  
          </div>  
          <iframe id="preview-frame" sandbox="allow-scripts allow-same-origin" class="flex-1 w-full"></iframe>  
        </div>  
      </div>  
    </main>  
  </div>  
</div>  

<script>  
const backendURL = "https://script.google.com/macros/s/AKfycbxledzNZPFP91QTS4a4z9394kQx7wZizNbs5VpOKnMa3HE2YK1r3HETvg1vuZt8m9SA/exec";  
const fileList = document.getElementById("file-list");  
const tabsContainer = document.querySelector("#tabs .flex");  
const editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {  
  mode: "r",  
  lineNumbers: true,  
  autoCloseBrackets: true,  
  styleActiveLine: true,  
  theme: "aquastudio",  
});  

let openFiles = [];  
let activeFile = "";  

// --- Fetch and Render Files from GitHub ---
async function loadFileList() {
  try {
    const res = await fetch(`${backendURL}?action=listFiles`);
    const files = await res.json();
    renderFileList(files);
  } catch (err) {
    console.error("Error fetching file list:", err);
    fileList.innerHTML = `<div class='text-red-400 text-sm'>⚠️ Failed to load files</div>`;
  }
}

function renderFileList(files) {
  fileList.innerHTML = "";
  files.forEach(file => {
    const btn = document.createElement("button");
    btn.dataset.file = file;
    btn.className = "file-item flex items-center gap-2 rounded-md px-3 py-2 text-sm hover:bg-accent/10 hover:text-accent truncate text-left";
    btn.innerHTML = `<span class="material-symbols-outlined text-base">description</span> ${file}`;
    fileList.appendChild(btn);
  });
}

// --- File search ---
document.getElementById("search-files").addEventListener("input", e => {
  const query = e.target.value.toLowerCase();
  document.querySelectorAll("#file-list .file-item").forEach(btn => {
    const match = btn.dataset.file.toLowerCase().includes(query);
    btn.style.display = match ? "" : "none";
  });
});

// --- Fetch File Content ---
async function fetchFileFromGitHub(filename) {
  try {
    const res = await fetch(`${backendURL}?action=getFile&path=${filename}`);
    const data = await res.json();
    return atob(data.content);
  } catch (err) {
    console.error("Error loading file:", err);
    return "# Error loading file from GitHub";
  }
}

// --- Save File ---
async function saveFileToGitHub(filename, content) {
  const saveBtn = document.getElementById("save-btn");
  saveBtn.disabled = true;
  saveBtn.innerHTML = `<span class="material-symbols-outlined">sync</span> Saving...`;
  saveBtn.classList.add("bg-blue-600", "text-white", "px-3", "rounded-md");

  try {
    const res = await fetch(backendURL, {
      method: "POST",
      body: JSON.stringify({ path: filename, newContent: content }),
    });
    const data = await res.json();

    saveBtn.innerHTML = `<span class="material-symbols-outlined">check_circle</span> Saved`;
    saveBtn.classList.remove("bg-blue-600");
    saveBtn.classList.add("bg-green-600");

    setTimeout(() => {
      saveBtn.disabled = false;
      saveBtn.innerHTML = `<span class="material-symbols-outlined">save</span> Save`;
      saveBtn.classList.remove("bg-green-600", "text-white", "px-3", "rounded-md");
    }, 3000);

    console.log("Saved:", data);
  } catch (err) {
    console.error("Error saving file:", err);
    saveBtn.disabled = false;
    saveBtn.innerHTML = `<span class="material-symbols-outlined">error</span> Error`;
    saveBtn.classList.add("bg-red-600", "text-white");
    setTimeout(() => {
      saveBtn.innerHTML = `<span class="material-symbols-outlined">save</span> Save`;
      saveBtn.classList.remove("bg-red-600", "text-white");
    }, 3000);
  }
}

// --- File Open Logic ---
async function openFile(filename) {
  if (!openFiles.includes(filename)) {
    openFiles.push(filename);
    const tab = document.createElement("a");
    tab.href = "#";
    tab.dataset.file = filename;
    tab.className = "tab flex items-center gap-2 border-b-2 border-transparent px-3 py-2 text-sm text-text-muted hover:border-accent/50 hover:text-text-light";
    tab.innerHTML = `${filename} <span class='material-symbols-outlined text-base cursor-pointer'>close</span>`;
    tabsContainer.appendChild(tab);
  }

  activeFile = filename;
  const content = await fetchFileFromGitHub(filename);
  editor.setValue(content);
  editor.refresh();
  updateTabs();
  highlightActiveFile();
  updatePreview();
}

function updateTabs() {
  document.querySelectorAll("#tabs .tab").forEach(tab => {
    const isActive = tab.dataset.file === activeFile;
    tab.classList.toggle("text-accent", isActive);
    tab.classList.toggle("border-accent", isActive);
  });
}

function highlightActiveFile() {
  document.querySelectorAll(".file-item").forEach(el => {
    el.classList.toggle("bg-accent/20", el.dataset.file === activeFile);
    el.classList.toggle("text-accent", el.dataset.file === activeFile);
    el.classList.toggle("font-bold", el.dataset.file === activeFile);
  });
}

// --- Preview ---
function updatePreview() {
  const htmlCode = editor.getValue();
  const iframe = document.getElementById("preview-frame");
  const doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open();
  doc.write(htmlCode);
  doc.close();
  doc.body.style.zoom = "0.7";
}
document.getElementById("clear-preview").addEventListener("click", () => {
  const iframe = document.getElementById("preview-frame");
  const doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open();
  doc.write("");
  doc.close();
});
editor.on("change", () => updatePreview());

// --- Events ---
tabsContainer.addEventListener("click", e => {
  const tab = e.target.closest(".tab");
  if (!tab) return;
  if (e.target.textContent === "close") {
    const file = tab.dataset.file;
    tab.remove();
    openFiles = openFiles.filter(f => f !== file);
    if (activeFile === file && openFiles.length > 0) openFile(openFiles[0]);
  } else openFile(tab.dataset.file);
});

fileList.addEventListener("click", e => {
  const btn = e.target.closest(".file-item");
  if (btn) openFile(btn.dataset.file);
});

document.getElementById("save-btn").addEventListener("click", () => {
  if (activeFile) saveFileToGitHub(activeFile, editor.getValue());
});

document.addEventListener("keydown", e => {
  if ((e.ctrlKey || e.metaKey) && e.key === "s") {
    e.preventDefault();
    if (activeFile) saveFileToGitHub(activeFile, editor.getValue());
  }
});

// --- Initialize ---
loadFileList();
</script>
</body>
</html>